<template>
  <div class="dynamicTable">
    <el-table :data="tableData" border @selection-change="handleSelectionChange">
      <el-table-column v-if="showCheckBox" type="selection" width="55" label="全选" />
      <el-table-column
        v-for="(item,index) in fieldArr"
        :key="index"
        :prop="item.key"
        :width="item.width"
      >
        <template slot="header" slot-scope="scope">
          <filtersDrop :item="item" />
          <!-- <span>{{ item.label }}</span>
          <span v-if="item.filters" class="arrow_triangle-down" />-->
        </template>
        <template slot-scope="scope">
          <div v-if="item.key=='operation'">
            <el-button
              v-for="(i,k) in item.buttons"
              :key="k"
              type="text"
              :class="setClass(i.colorType)"
              @click="handleClick(i,scope.row)"
            >{{ i.label }}</el-button>
          </div>
          <div v-else-if="item.formatter">
            <div v-format="[scope.row[item.key],item.formatter,scope.row,themeGroup]" />
          </div>
          <div v-else>{{ scope.row[item.key] }}</div>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
<script>
import { mapGetters } from 'vuex'
import filtersDrop from './filter'
function format (el, bingind, vnode) {
  const key = bingind.value[0];
  const arr = bingind.value[1];
  const data = bingind.value[2];
  const themeGroup = bingind.value[3];
  if (typeof arr === 'string') {
    const reg = /[^\(\)]+(?=\))/g;
    const arrName = arr.match(reg);
    let str = arr;
    arrName.forEach((item) => {
      str = str.replace(`(${item})`, data[item])
    })
    el.innerHTML = `<span>${str}</span>`
  } else {
    const obj = arr.find((item) => { return item.key === key });
    const color = obj.color ? themeGroup[obj.color] : themeGroup.highLight;
    el.innerHTML = `<span style="color:${color}">${obj.label}</span>`
  }
}
export default {
  directives: {
    format: {
      inserted: function (el, bingind, vnode) {
        format(el, bingind, vnode)
      },
      bind: function () {
      },
      update: function (el, bingind, vnode) {
        if (JSON.stringify(bingind.oldValue) !== JSON.stringify(bingind.value)) {
          format(el, bingind, vnode)
        }
      },
      componentUpdated: function (el, bingind, vnode) {
      },
      unbind: function () {
      }
    }
  },
  components: {
    filtersDrop
  },
  props: {
    getters: {
      type: String,
      default: ''
    },
    filters: {
      type: Object,
      default: () => {
        return {}
      }
    },
    showCheckBox: {
      type: Boolean,
      default: false
    },
    fieldArr: {
      type: Array,
      default: () => {
        return []
      }
    }
  },
  computed: {
    ...mapGetters({
      'themeGroup': 'themeGroup'
    }),
    tableData: function () {
      return this.$store.getters[this.getters]
    }
  },
  methods: {
    setClass (item) {
      const obj = {};
      obj[item] = true;
      return obj;
    },
    handleClick (i, data) {
      if (i.type === 'url') {
        const query = {};
        i.query.forEach((item) => {
          query[item] = data[item]
        })
        this.$router.push({ path: i.path, query: query })
      }
      if (i.type === 'button') {
        this.$emit(i.method, data)
      }
    },
    filterTag () {
      console.log(1)
    },
    handleSelectionChange () {

    }
  }
}
</script>
<style lang="scss" scope>
.dynamicTable {
  .el-table--medium th {
    padding: 0;
    background-color: #e8ebf3;
  }
  .el-table th.gutter {
    display: table-cell !important;
  }
  .el-table th > .cell {
    padding: 0 !important;
  }
  .el-table thead {
    color: #25243e;
    background-color: #e8ebf3;
  }
  .el-table--border,
  .el-table--group {
    border: none;
  }
  .el-table td,
  .el-table th.is-leaf {
    border-color: #dedfe3;
    text-align: center;
  }
  .edit {
    color: #7f83d8;
  }
  .delete {
    color: #fe9c02;
  }
}
</style>
